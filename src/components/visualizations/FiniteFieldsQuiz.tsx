import { useState } from 'react';

type Difficulty = 'easy' | 'medium' | 'hard';

interface MultipleChoiceQuestion {
  type: 'multiple-choice';
  question: string;
  options: string[];
  correctAnswer: number;
  explanation: string;
}

interface FreeResponseQuestion {
  type: 'free-response';
  question: string;
  correctAnswer: string;
  acceptableAnswers: string[];
  explanation: string;
}

type Question = MultipleChoiceQuestion | FreeResponseQuestion;

function generateOrderQuestion(difficulty: Difficulty): Question {
  if (difficulty === 'easy') {
    return {
      type: 'multiple-choice',
      question: 'Finite fields exist only for which orders?',
      options: [
        'Any positive integer',
        'Any prime number',
        'Prime powers (pⁿ)',
        'Powers of 2'
      ],
      correctAnswer: 2,
      explanation: 'Finite fields exist exactly for orders pⁿ where p is prime and n ≥ 1.'
    };
  } else if (difficulty === 'medium') {
    return {
      type: 'multiple-choice',
      question: 'Is there a field of order 6?',
      options: [
        'Yes, it\'s Z₆',
        'Yes, constructed from Z₂ and Z₃',
        'No, 6 is not a prime power',
        'No, 6 is too small'
      ],
      correctAnswer: 2,
      explanation: '6 = 2 × 3 is not a prime power, so no field of order 6 exists.'
    };
  } else {
    return {
      type: 'free-response',
      question: 'How many elements does F₂₅ have?',
      correctAnswer: '25',
      acceptableAnswers: ['25', 'twenty-five'],
      explanation: 'F₂₅ = F₅² has 25 elements. It\'s a degree-2 extension of F₅.'
    };
  }
}

function generateConstructionQuestion(difficulty: Difficulty): Question {
  if (difficulty === 'easy') {
    return {
      type: 'multiple-choice',
      question: 'F₄ can be constructed as:',
      options: [
        'Z₄',
        'Z₂ × Z₂',
        'F₂[x]/(x² + x + 1)',
        'F₂[x]/(x²)'
      ],
      correctAnswer: 2,
      explanation: 'F₄ = F₂[x]/(x² + x + 1) where x² + x + 1 is irreducible over F₂.'
    };
  } else if (difficulty === 'medium') {
    return {
      type: 'multiple-choice',
      question: 'To construct F₈, we need an irreducible polynomial over F₂ of degree:',
      options: ['2', '3', '4', '8'],
      correctAnswer: 1,
      explanation: 'F₈ = F₂³, so we need an irreducible polynomial of degree 3, like x³ + x + 1.'
    };
  } else {
    return {
      type: 'multiple-choice',
      question: 'In F₈ = F₂[x]/(x³ + x + 1), if α is a root of x³ + x + 1, what is α³?',
      options: ['0', '1', 'α', 'α + 1'],
      correctAnswer: 3,
      explanation: 'Since α³ + α + 1 = 0 in this field, we have α³ = -α - 1 = α + 1 (in characteristic 2).'
    };
  }
}

function generateMultiplicativeQuestion(difficulty: Difficulty): Question {
  if (difficulty === 'easy') {
    return {
      type: 'multiple-choice',
      question: 'The multiplicative group F_q* of a finite field is:',
      options: [
        'Trivial',
        'Cyclic',
        'Abelian but not cyclic',
        'Non-abelian'
      ],
      correctAnswer: 1,
      explanation: 'F_q* is always cyclic of order q - 1. This is a fundamental theorem about finite fields.'
    };
  } else if (difficulty === 'medium') {
    return {
      type: 'free-response',
      question: 'What is the order of the multiplicative group F₇*?',
      correctAnswer: '6',
      acceptableAnswers: ['6', 'six'],
      explanation: '|F₇*| = 7 - 1 = 6. The nonzero elements form a cyclic group of order 6.'
    };
  } else {
    return {
      type: 'multiple-choice',
      question: 'A primitive element of F_q is:',
      options: [
        'Any nonzero element',
        'An element of order q',
        'A generator of F_q*',
        'An element satisfying x^p = x'
      ],
      correctAnswer: 2,
      explanation: 'A primitive element generates F_q* multiplicatively, so it has order q - 1.'
    };
  }
}

function generateFrobeniusQuestion(difficulty: Difficulty): Question {
  if (difficulty === 'easy') {
    return {
      type: 'multiple-choice',
      question: 'The Frobenius automorphism on F_pⁿ is the map:',
      options: [
        'x ↦ x + 1',
        'x ↦ x^p',
        'x ↦ px',
        'x ↦ x^n'
      ],
      correctAnswer: 1,
      explanation: 'The Frobenius automorphism is φ(x) = x^p. It fixes F_p and generates Gal(F_pⁿ/F_p).'
    };
  } else if (difficulty === 'medium') {
    return {
      type: 'multiple-choice',
      question: 'The Galois group Gal(F_pⁿ/F_p) is isomorphic to:',
      options: ['Z_p', 'Z_n', 'Z_pⁿ', 'S_n'],
      correctAnswer: 1,
      explanation: 'Gal(F_pⁿ/F_p) = ⟨φ⟩ ≅ Z_n, generated by the Frobenius φ(x) = x^p of order n.'
    };
  } else {
    return {
      type: 'free-response',
      question: 'What is the order of the Frobenius automorphism on F₆₄ = F₂⁶?',
      correctAnswer: '6',
      acceptableAnswers: ['6', 'six'],
      explanation: 'The Frobenius φ(x) = x² has order 6, equal to [F₆₄:F₂] = 6.'
    };
  }
}

function generateSubfieldQuestion(difficulty: Difficulty): Question {
  if (difficulty === 'easy') {
    return {
      type: 'multiple-choice',
      question: 'F_pᵐ is a subfield of F_pⁿ if and only if:',
      options: [
        'm < n',
        'm > n',
        'm divides n',
        'm and n are coprime'
      ],
      correctAnswer: 2,
      explanation: 'F_pᵐ ⊆ F_pⁿ ⟺ m | n. Subfields correspond to divisors of the extension degree.'
    };
  } else if (difficulty === 'medium') {
    return {
      type: 'multiple-choice',
      question: 'The subfields of F₆₄ = F₂⁶ are:',
      options: [
        'F₂ only',
        'F₂, F₄, F₈',
        'F₂, F₄, F₈, F₆₄',
        'F₂, F₄, F₆₄'
      ],
      correctAnswer: 2,
      explanation: 'Divisors of 6 are 1, 2, 3, 6, giving subfields F₂, F₄, F₈, F₆₄.'
    };
  } else {
    return {
      type: 'multiple-choice',
      question: 'Which is NOT a subfield of F₂₅₆ = F₂⁸?',
      options: ['F₄', 'F₈', 'F₁₆', 'F₃₂'],
      correctAnswer: 3,
      explanation: 'F₃₂ = F₂⁵, and 5 does not divide 8. So F₃₂ is not a subfield of F₂₅₆.'
    };
  }
}

const questionGenerators = [
  generateOrderQuestion,
  generateConstructionQuestion,
  generateMultiplicativeQuestion,
  generateFrobeniusQuestion,
  generateSubfieldQuestion
];

export function FiniteFieldsQuiz() {
  const [difficulty, setDifficulty] = useState<Difficulty>('medium');
  const [questions, setQuestions] = useState<Question[]>([]);
  const [currentQuestion, setCurrentQuestion] = useState(0);
  const [score, setScore] = useState(0);
  const [showResult, setShowResult] = useState(false);
  const [selectedAnswer, setSelectedAnswer] = useState<number | null>(null);
  const [textAnswer, setTextAnswer] = useState('');
  const [answered, setAnswered] = useState(false);
  const [quizStarted, setQuizStarted] = useState(false);

  const startQuiz = () => {
    const newQuestions = questionGenerators.map(gen => gen(difficulty));
    setQuestions(newQuestions);
    setCurrentQuestion(0);
    setScore(0);
    setShowResult(false);
    setSelectedAnswer(null);
    setTextAnswer('');
    setAnswered(false);
    setQuizStarted(true);
  };

  const handleAnswer = () => {
    const question = questions[currentQuestion];
    let isCorrect = false;

    if (question.type === 'multiple-choice') {
      isCorrect = selectedAnswer === question.correctAnswer;
    } else {
      isCorrect = question.acceptableAnswers.some(
        ans => textAnswer.toLowerCase().trim() === ans.toLowerCase()
      );
    }

    if (isCorrect) setScore(score + 1);
    setAnswered(true);
  };

  const nextQuestion = () => {
    if (currentQuestion < questions.length - 1) {
      setCurrentQuestion(currentQuestion + 1);
      setSelectedAnswer(null);
      setTextAnswer('');
      setAnswered(false);
    } else {
      setShowResult(true);
    }
  };

  if (!quizStarted) {
    return (
      <div className="card">
        <h4 className="text-lg font-semibold mb-4">Finite Fields Quiz</h4>
        <div className="mb-4">
          <label className="block text-sm text-dark-400 mb-2">Select Difficulty:</label>
          <div className="flex gap-2">
            {(['easy', 'medium', 'hard'] as Difficulty[]).map(d => (
              <button
                key={d}
                onClick={() => setDifficulty(d)}
                className={`px-4 py-2 rounded capitalize ${
                  difficulty === d
                    ? 'bg-primary-600 text-white'
                    : 'bg-dark-700 text-dark-300 hover:bg-dark-600'
                }`}
              >
                {d}
              </button>
            ))}
          </div>
        </div>
        <button onClick={startQuiz} className="btn-primary">
          Start Quiz
        </button>
      </div>
    );
  }

  if (showResult) {
    return (
      <div className="card">
        <h4 className="text-lg font-semibold mb-4">Quiz Complete!</h4>
        <p className="text-xl mb-4">
          Score: {score} / {questions.length}
        </p>
        <button onClick={() => setQuizStarted(false)} className="btn-primary">
          Try Again
        </button>
      </div>
    );
  }

  const question = questions[currentQuestion];

  return (
    <div className="card">
      <div className="flex justify-between items-center mb-4">
        <h4 className="text-lg font-semibold">Question {currentQuestion + 1} of {questions.length}</h4>
        <span className="text-sm text-dark-400 capitalize">{difficulty}</span>
      </div>

      <p className="mb-4">{question.question}</p>

      {question.type === 'multiple-choice' ? (
        <div className="space-y-2 mb-4">
          {question.options.map((option, idx) => (
            <button
              key={idx}
              onClick={() => !answered && setSelectedAnswer(idx)}
              disabled={answered}
              className={`w-full text-left p-3 rounded transition-colors ${
                answered
                  ? idx === question.correctAnswer
                    ? 'bg-green-600/30 border border-green-500'
                    : idx === selectedAnswer
                    ? 'bg-red-600/30 border border-red-500'
                    : 'bg-dark-700'
                  : selectedAnswer === idx
                  ? 'bg-primary-600/30 border border-primary-500'
                  : 'bg-dark-700 hover:bg-dark-600'
              }`}
            >
              {option}
            </button>
          ))}
        </div>
      ) : (
        <div className="mb-4">
          <input
            type="text"
            value={textAnswer}
            onChange={(e) => setTextAnswer(e.target.value)}
            disabled={answered}
            className="w-full p-3 rounded bg-dark-700 border border-dark-600 focus:border-primary-500 focus:outline-none"
            placeholder="Enter your answer"
          />
          {answered && (
            <p className={`mt-2 ${
              question.acceptableAnswers.some(a => textAnswer.toLowerCase().trim() === a.toLowerCase())
                ? 'text-green-400'
                : 'text-red-400'
            }`}>
              Correct answer: {question.correctAnswer}
            </p>
          )}
        </div>
      )}

      {answered && (
        <div className="mb-4 p-3 bg-dark-700 rounded">
          <p className="text-dark-300">{question.explanation}</p>
        </div>
      )}

      <div className="flex gap-2">
        {!answered ? (
          <button
            onClick={handleAnswer}
            disabled={question.type === 'multiple-choice' ? selectedAnswer === null : textAnswer.trim() === ''}
            className="btn-primary disabled:opacity-50"
          >
            Submit Answer
          </button>
        ) : (
          <button onClick={nextQuestion} className="btn-primary">
            {currentQuestion < questions.length - 1 ? 'Next Question' : 'See Results'}
          </button>
        )}
      </div>
    </div>
  );
}
