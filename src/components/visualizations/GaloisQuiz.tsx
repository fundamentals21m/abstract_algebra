import { useState } from 'react';

type Difficulty = 'easy' | 'medium' | 'hard';

interface MultipleChoiceQuestion {
  type: 'multiple-choice';
  question: string;
  options: string[];
  correctAnswer: number;
  explanation: string;
}

interface FreeResponseQuestion {
  type: 'free-response';
  question: string;
  correctAnswer: string;
  acceptableAnswers: string[];
  explanation: string;
}

type Question = MultipleChoiceQuestion | FreeResponseQuestion;

function generateExtensionQuestion(difficulty: Difficulty): Question {
  if (difficulty === 'easy') {
    return {
      type: 'multiple-choice',
      question: 'What is [C:R], the degree of C over R?',
      options: ['1', '2', '∞', 'undefined'],
      correctAnswer: 1,
      explanation: 'C has basis {1, i} over R, so [C:R] = 2.'
    };
  } else if (difficulty === 'medium') {
    return {
      type: 'multiple-choice',
      question: 'What is [Q(√2):Q]?',
      options: ['1', '2', '3', '4'],
      correctAnswer: 1,
      explanation: '√2 is a root of x² - 2, which is irreducible over Q, so the degree is 2.'
    };
  } else {
    return {
      type: 'free-response',
      question: 'What is [Q(∛2, ω):Q] where ω = e^(2πi/3)?',
      correctAnswer: '6',
      acceptableAnswers: ['6', 'six'],
      explanation: '[Q(∛2):Q] = 3 and [Q(∛2, ω):Q(∛2)] = 2, so by the tower law, the total degree is 6.'
    };
  }
}

function generateGaloisGroupQuestion(difficulty: Difficulty): Question {
  if (difficulty === 'easy') {
    return {
      type: 'multiple-choice',
      question: 'The Galois group Gal(Q(√2)/Q) is isomorphic to:',
      options: ['Z₁', 'Z₂', 'Z₃', 'Z₄'],
      correctAnswer: 1,
      explanation: 'There are 2 automorphisms: identity and √2 ↦ -√2. So Gal ≅ Z₂.'
    };
  } else if (difficulty === 'medium') {
    return {
      type: 'multiple-choice',
      question: 'The Galois group of the splitting field of x³ - 2 over Q is isomorphic to:',
      options: ['Z₃', 'Z₆', 'S₃', 'A₃'],
      correctAnswer: 2,
      explanation: 'The splitting field is Q(∛2, ω) with degree 6. The Galois group is S₃ (all permutations of the 3 roots).'
    };
  } else {
    return {
      type: 'multiple-choice',
      question: 'Gal(Q(√2, √3)/Q) is isomorphic to:',
      options: ['Z₄', 'Z₂ × Z₂', 'D₄', 'S₃'],
      correctAnswer: 1,
      explanation: 'The 4 automorphisms independently map √2 ↦ ±√2 and √3 ↦ ±√3, giving Z₂ × Z₂.'
    };
  }
}

function generateCorrespondenceQuestion(difficulty: Difficulty): Question {
  if (difficulty === 'easy') {
    return {
      type: 'multiple-choice',
      question: 'In the Galois correspondence, larger subgroups correspond to:',
      options: [
        'Larger intermediate fields',
        'Smaller intermediate fields',
        'No intermediate fields',
        'The base field only'
      ],
      correctAnswer: 1,
      explanation: 'The Galois correspondence is inclusion-reversing: larger subgroups ↔ smaller fixed fields.'
    };
  } else if (difficulty === 'medium') {
    return {
      type: 'multiple-choice',
      question: 'An intermediate field K is Galois over F if and only if:',
      options: [
        'Gal(E/K) is abelian',
        'Gal(E/K) is a normal subgroup of Gal(E/F)',
        'Gal(E/K) is cyclic',
        '[K:F] is prime'
      ],
      correctAnswer: 1,
      explanation: 'K/F is Galois ⟺ Gal(E/K) ⊴ Gal(E/F), and then Gal(K/F) ≅ Gal(E/F)/Gal(E/K).'
    };
  } else {
    return {
      type: 'multiple-choice',
      question: 'If [E:F] = |Gal(E/F)|, then E/F is:',
      options: [
        'Separable only',
        'Normal only',
        'Galois',
        'Finite'
      ],
      correctAnswer: 2,
      explanation: 'This equality is one characterization of a Galois extension.'
    };
  }
}

function generateSplittingQuestion(difficulty: Difficulty): Question {
  if (difficulty === 'easy') {
    return {
      type: 'multiple-choice',
      question: 'A splitting field for a polynomial f(x) is:',
      options: [
        'Any field where f has a root',
        'The smallest field where f factors completely into linear factors',
        'The field generated by the leading coefficient',
        'Always equal to the base field'
      ],
      correctAnswer: 1,
      explanation: 'The splitting field is the minimal extension where f splits completely into linear factors.'
    };
  } else if (difficulty === 'medium') {
    return {
      type: 'multiple-choice',
      question: 'The splitting field of x² - 2 over Q is:',
      options: ['Q', 'Q(√2)', 'Q(i)', 'R'],
      correctAnswer: 1,
      explanation: 'x² - 2 = (x - √2)(x + √2), so the splitting field is Q(√2) which contains both roots.'
    };
  } else {
    return {
      type: 'multiple-choice',
      question: 'If deg(f) = n, then the degree of the splitting field over F is at most:',
      options: ['n', 'n²', 'n!', '2ⁿ'],
      correctAnswer: 2,
      explanation: '[E:F] ≤ n! with equality when Gal(f) = Sₙ (the generic case).'
    };
  }
}

function generateSolvabilityQuestion(difficulty: Difficulty): Question {
  if (difficulty === 'easy') {
    return {
      type: 'multiple-choice',
      question: 'A polynomial is solvable by radicals if its Galois group is:',
      options: ['Cyclic', 'Abelian', 'Solvable', 'Simple'],
      correctAnswer: 2,
      explanation: 'Galois\'s theorem: f is solvable by radicals ⟺ Gal(f) is a solvable group.'
    };
  } else if (difficulty === 'medium') {
    return {
      type: 'multiple-choice',
      question: 'Which symmetric group is NOT solvable?',
      options: ['S₂', 'S₃', 'S₄', 'S₅'],
      correctAnswer: 3,
      explanation: 'S₅ is not solvable because A₅ is simple and non-abelian. Sₙ for n ≥ 5 is not solvable.'
    };
  } else {
    return {
      type: 'multiple-choice',
      question: 'The general quintic is not solvable by radicals because:',
      options: [
        'It has 5 roots',
        'Its Galois group can be S₅, which is not solvable',
        'Degree 5 is prime',
        'It has no real roots'
      ],
      correctAnswer: 1,
      explanation: 'The generic quintic has Galois group S₅, which is not solvable, so no radical formula exists.'
    };
  }
}

const questionGenerators = [
  generateExtensionQuestion,
  generateGaloisGroupQuestion,
  generateCorrespondenceQuestion,
  generateSplittingQuestion,
  generateSolvabilityQuestion
];

export function GaloisQuiz() {
  const [difficulty, setDifficulty] = useState<Difficulty>('medium');
  const [questions, setQuestions] = useState<Question[]>([]);
  const [currentQuestion, setCurrentQuestion] = useState(0);
  const [score, setScore] = useState(0);
  const [showResult, setShowResult] = useState(false);
  const [selectedAnswer, setSelectedAnswer] = useState<number | null>(null);
  const [textAnswer, setTextAnswer] = useState('');
  const [answered, setAnswered] = useState(false);
  const [quizStarted, setQuizStarted] = useState(false);

  const startQuiz = () => {
    const newQuestions = questionGenerators.map(gen => gen(difficulty));
    setQuestions(newQuestions);
    setCurrentQuestion(0);
    setScore(0);
    setShowResult(false);
    setSelectedAnswer(null);
    setTextAnswer('');
    setAnswered(false);
    setQuizStarted(true);
  };

  const handleAnswer = () => {
    const question = questions[currentQuestion];
    let isCorrect = false;

    if (question.type === 'multiple-choice') {
      isCorrect = selectedAnswer === question.correctAnswer;
    } else {
      isCorrect = question.acceptableAnswers.some(
        ans => textAnswer.toLowerCase().trim() === ans.toLowerCase()
      );
    }

    if (isCorrect) setScore(score + 1);
    setAnswered(true);
  };

  const nextQuestion = () => {
    if (currentQuestion < questions.length - 1) {
      setCurrentQuestion(currentQuestion + 1);
      setSelectedAnswer(null);
      setTextAnswer('');
      setAnswered(false);
    } else {
      setShowResult(true);
    }
  };

  if (!quizStarted) {
    return (
      <div className="card">
        <h4 className="text-lg font-semibold mb-4">Galois Theory Quiz</h4>
        <div className="mb-4">
          <label className="block text-sm text-dark-400 mb-2">Select Difficulty:</label>
          <div className="flex gap-2">
            {(['easy', 'medium', 'hard'] as Difficulty[]).map(d => (
              <button
                key={d}
                onClick={() => setDifficulty(d)}
                className={`px-4 py-2 rounded capitalize ${
                  difficulty === d
                    ? 'bg-primary-600 text-white'
                    : 'bg-dark-700 text-dark-300 hover:bg-dark-600'
                }`}
              >
                {d}
              </button>
            ))}
          </div>
        </div>
        <button onClick={startQuiz} className="btn-primary">
          Start Quiz
        </button>
      </div>
    );
  }

  if (showResult) {
    return (
      <div className="card">
        <h4 className="text-lg font-semibold mb-4">Quiz Complete!</h4>
        <p className="text-xl mb-4">
          Score: {score} / {questions.length}
        </p>
        <button onClick={() => setQuizStarted(false)} className="btn-primary">
          Try Again
        </button>
      </div>
    );
  }

  const question = questions[currentQuestion];

  return (
    <div className="card">
      <div className="flex justify-between items-center mb-4">
        <h4 className="text-lg font-semibold">Question {currentQuestion + 1} of {questions.length}</h4>
        <span className="text-sm text-dark-400 capitalize">{difficulty}</span>
      </div>

      <p className="mb-4">{question.question}</p>

      {question.type === 'multiple-choice' ? (
        <div className="space-y-2 mb-4">
          {question.options.map((option, idx) => (
            <button
              key={idx}
              onClick={() => !answered && setSelectedAnswer(idx)}
              disabled={answered}
              className={`w-full text-left p-3 rounded transition-colors ${
                answered
                  ? idx === question.correctAnswer
                    ? 'bg-green-600/30 border border-green-500'
                    : idx === selectedAnswer
                    ? 'bg-red-600/30 border border-red-500'
                    : 'bg-dark-700'
                  : selectedAnswer === idx
                  ? 'bg-primary-600/30 border border-primary-500'
                  : 'bg-dark-700 hover:bg-dark-600'
              }`}
            >
              {option}
            </button>
          ))}
        </div>
      ) : (
        <div className="mb-4">
          <input
            type="text"
            value={textAnswer}
            onChange={(e) => setTextAnswer(e.target.value)}
            disabled={answered}
            className="w-full p-3 rounded bg-dark-700 border border-dark-600 focus:border-primary-500 focus:outline-none"
            placeholder="Enter your answer"
          />
          {answered && (
            <p className={`mt-2 ${
              question.acceptableAnswers.some(a => textAnswer.toLowerCase().trim() === a.toLowerCase())
                ? 'text-green-400'
                : 'text-red-400'
            }`}>
              Correct answer: {question.correctAnswer}
            </p>
          )}
        </div>
      )}

      {answered && (
        <div className="mb-4 p-3 bg-dark-700 rounded">
          <p className="text-dark-300">{question.explanation}</p>
        </div>
      )}

      <div className="flex gap-2">
        {!answered ? (
          <button
            onClick={handleAnswer}
            disabled={question.type === 'multiple-choice' ? selectedAnswer === null : textAnswer.trim() === ''}
            className="btn-primary disabled:opacity-50"
          >
            Submit Answer
          </button>
        ) : (
          <button onClick={nextQuestion} className="btn-primary">
            {currentQuestion < questions.length - 1 ? 'Next Question' : 'See Results'}
          </button>
        )}
      </div>
    </div>
  );
}
